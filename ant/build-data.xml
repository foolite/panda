<?xml version="1.0" encoding="UTF-8"?>
<project name="panda-build-data" basedir=".">
	<target name="db-imp-xls" description="Import XLS data to database">
		<taskdef name="impxls" classname="nuts.tools.sql.XlsDataImportor" classpathref="tools.cp"/>
		<impxls source="${db.data}" includes="*.xls"
			truncate="true" verbose="${imp.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>
		
	<target name="db-imp-res" description="Import resource properties files to database">
		<taskdef name="execsql" classname="nuts.tools.sql.SqlExecutor" classpathref="tools.cp"/>
		<execsql sql="DELETE FROM RESOURCE;COMMIT;" verbose="${sql.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>

		<property name="pro.sql.ins" value="INSERT INTO RESOURCE VALUES(null, :clazz, :language, :country, :name, :value, null, '0', 0, now())"/>
		<taskdef name="imppro" classname="nuts.tools.sql.PropertyImportor" classpathref="tools.cp"/>
		<imppro source="${main.res}" includes="${db.imp.path}/**/*.properties"
			insertSql="${pro.sql.ins}" prefix="${db.imp.pref}"
			emptystr="*" verbose="${imp.verbose}"
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>

	<target name="db-imp-tpl" description="Import template source files to database">
		<taskdef name="execsql" classname="nuts.tools.sql.SqlExecutor" classpathref="tools.cp"/>
		<execsql sql="DELETE FROM TEMPLATE;COMMIT;" verbose="${sql.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>

		<taskdef name="imptpl" classname="nuts.tools.sql.TemplateImportor" classpathref="tools.cp"/>
		<property name="tpl.sql.upd" value="UPDATE TEMPLATE SET SOURCE=:source WHERE NAME=:name AND LANGUAGE=:language AND COUNTRY=:country"/>
		<property name="tpl.sql.ins" value="INSERT INTO TEMPLATE VALUES(null, :name, :language, :country, :source, '0', 0, now())"/>
		<imptpl source="${db.tpl}" includes="**/*.ftl"
			encoding="UTF-8" emptystr="*" verbose="${imp.verbose}"
			insertSql="${tpl.sql.ins}" updateSql="${tpl.sql.upd}"
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>

	<target name="db-hsqldb-mkdir" if="hsqldb.dir" description="Create HSQLDB dir">
		<mkdir dir="${hsqldb.dir}"/>
	</target>

	<target name="db-aems-cpddl" description="Copy nuts-aems generated ddl files to ${gen.ddl} directory">
		<delete dir="${gen.ddl.aems}"/>
		<mkdir dir="${gen.ddl.aems}"/>
		<unjar dest="${gen.ddl.aems}">
			<fileset dir="${sdk.nuts}">
				<include name="nuts-aems-*-ddl.jar"/>
			</fileset>
			<patternset>
				<exclude name="META-INF/**"/>
			</patternset>
		</unjar>
	</target>

	<target name="db-init-aems" if="aems.ddl" depends="db-aems-cpddl" description="Initialize nuts.aems database schema">
		<taskdef name="execsql" classname="nuts.tools.sql.SqlExecutor" classpathref="tools.cp"/>
		<execsql source="${gen.ddl.aems}/${data.vendor}/all.sql" charset="UTF-8" verbose="${sql.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>
	
	<target name="db-init-app" depends="db-hsqldb-mkdir,db-init-aems" description="Initialize app database schema">
		<taskdef name="execsql" classname="nuts.tools.sql.SqlExecutor" classpathref="tools.cp"/>
		<execsql source="${gen.ddl}/${data.vendor}/all.sql" charset="UTF-8" verbose="${sql.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>
	
	<target name="db-init" depends="db-init-aems,db-init-app" description="Initialize database schema"/>

	<target name="db-hsqldb-deldir" if="hsqldb.dir" description="Delete HSQLDB dir">
		<delete dir="${hsqldb.dir}"/>
	</target>

	<target name="db-drop-aems" if="aems.ddl" depends="db-aems-cpddl" description="Drop nuts.aems database schema">
		<taskdef name="execsql" classname="nuts.tools.sql.SqlExecutor" classpathref="tools.cp"/>
		<execsql source="${gen.ddl.aems}/${data.vendor}/drop-all.sql" charset="UTF-8" ignoreError="true" verbose="${sql.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>

	<target name="db-drop-app" depends="db-aems-cpddl" description="Drop app database schema">
		<taskdef name="execsql" classname="nuts.tools.sql.SqlExecutor" classpathref="tools.cp"/>
		<execsql source="${gen.ddl}/${data.vendor}/drop-all.sql" charset="UTF-8" ignoreError="true" verbose="${sql.verbose}" 
			jdbcDriver="${jdbc.driver}" jdbcUrl="${jdbc.url}"
			jdbcUsername="${jdbc.username}" jdbcPassword="${jdbc.password}"/>
	</target>

	<target name="db-drop" depends="db-drop-app, db-drop-aems" description="Drop database schema"/>
</project>
