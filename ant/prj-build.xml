<?xml version="1.0" encoding="UTF-8"?>
<project name="prj-build">
	<property name="src.dir" value="src"/>
	<property name="out.dir" value="out"/>
	<property name="javac.debug" value="true"/>

	<tstamp>
		<format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss"/>
	</tstamp>

	<!-- path -->
	<path id="main.cp">
		<pathelement path="out/classes"/>
		<path refid="dep.cp"/>
	</path>

	<path id="lib.cp">
		<fileset dir="lib/api" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/jdbc" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/run" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/tool" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
	</path>

	<!-- build -->
	<target name="clean" description="Delete everything in the output directory">
		<delete dir="${out.dir}"/>
	</target>

	<target name="cp-fonts" description="Copy fonts to the web/WEB-INF/fonts directory">
		<delete dir="web/WEB-INF/fonts" />
		<copy todir="web/WEB-INF/fonts" preservelastmodified="true">
			<fileset dir="../panda-asserts/fonts" />
		</copy>
	</target>

	<target name="cp-res" description="Copy resource files to the classes directory">
		<mkdir dir="${out.dir}/classes"/>
		<delete>
			<fileset dir="${out.dir}/classes">
				<exclude name="**/*.class"/>
			</fileset>
		</delete>
		<copy todir="${out.dir}/classes" preservelastmodified="true">
			<fileset dir="${src.dir}/main/java">
				<exclude name="**/*.java"/>
			</fileset>
			<fileset dir="${src.dir}/main/resources" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${src.dir}/main/templates" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${src.dir}/gen/java" erroronmissingdir="false">
				<exclude name="**/*.java"/>
			</fileset>
			<fileset dir="${src.dir}/gen/resources" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${src.dir}/gen/templates" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
		</copy>
	</target>

	<target name="dir-chk">
		<available file="${dir}" type="dir" property="dir.exists"/>
	</target>
	<target name="n2a-do" depends="dir-chk" if="dir.exists">
		<native2ascii src="${dir}" dest="${out.dir}/classes" encoding="UTF-8" includes="**/*_*.properties"/>
	</target>
	<target name="n2a" description="Convert native properties to ascii properties">
		<delete>
			<fileset dir="${out.dir}/classes">
				<include name="**/*_*.properties"/>
			</fileset>
		</delete>
		<antcall target="n2a-do">
			<param name="dir" value="${src.dir}/main/resources"/>
		</antcall>
		<antcall target="n2a-do">
			<param name="dir" value="${src.dir}/gen/resources"/>
		</antcall>
	</target>

	<target name="javac" description="Compile java source files">
		<mkdir dir="${out.dir}/classes"/>
		<touch>
			<fileset dir="${src.dir}/main/java" includes="**/package-info.java"/>
			<fileset dir="${src.dir}/gen/java" includes="**/package-info.java" erroronmissingdir="false"/>
		</touch>
		<condition property="srcdir" value="${src.dir}/main/java:${src.dir}/gen/java">
			<available file="${src.dir}/gen/java"/>
		</condition>
		<property name="srcdir" value="${src.dir}/main/java"/>
		<javac srcdir="${srcdir}" destdir="${out.dir}/classes" encoding="UTF-8" debug="${javac.debug}" includeAntRuntime="false">
			<classpath refid="main.cp"/>
		</javac>
	</target>

	<target name="javadoc" description="Generate java documents">
		<delete includeemptydirs="true">
			<fileset dir="${out.dir}">
				<include name="javadoc/**"/>
			</fileset>
		</delete>
		<javadoc 
			destdir="${out.dir}/javadoc"
			encoding="UTF-8" docencoding="UTF-8" charset="UTF-8" locale="en_US"
			use="true" splitindex="true" useexternalfile="yes"
			windowTitle="${prj.title} ${prj.version} API"
			doctitle="${prj.title} ${prj.version} API"
			footer="&lt;a href=&quot;${prj.url}&quot;&gt;${prj.url}&lt;/a&gt;"
		>
			<fileset dir="${src.dir}/main/java"/>
			<fileset dir="${src.dir}/gen/java" erroronmissingdir="false"/>
			<classpath refid="main.cp"/>
		</javadoc>
	</target>
	
	<!-- dist -->
	<target name="jardoc" description="Compress java documents to a jar file">
		<delete>
			<fileset dir="${out.dir}">
				<include name="*-javadoc.jar"/>
			</fileset>
		</delete>
		<jar destfile="${out.dir}/${prj.name}-${VERSION}-javadoc.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.org}"/>
				<attribute name="Built-By" value="${prj.org}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/>
				<attribute name="Implementation-Vendor" value="${prj.url}"/>
			</manifest>
			<fileset dir="${out.dir}/javadoc"/>
		</jar>
	</target>

	<target name="jarsrc" description="Compress source files to a jar file">
		<delete>
			<fileset dir="${out.dir}">
				<include name="*-sources.jar"/>
			</fileset>
		</delete>
		<jar destfile="${out.dir}/${prj.name}-${VERSION}-sources.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.org}"/>
				<attribute name="Built-By" value="${prj.org}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/> 
				<attribute name="Implementation-Vendor" value="${prj.url}"/>
			</manifest>
			<fileset dir="${src.dir}/main/java"/>
			<fileset dir="${src.dir}/main/resources" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/main/templates" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/gen/java" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/gen/resources" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/gen/templates" erroronmissingdir="false"/>
			<fileset dir="${out.dir}/classes" includes="META-INF/LICENSE" erroronmissingdir="false"/>
		</jar>
	</target>

	<target name="jar" description="Compress compiled output files to a jar file">
		<delete>
			<fileset dir="${out.dir}">
				<include name="*.jar"/>
				<exclude name="*-javadoc.jar"/>
				<exclude name="*-sources.jar"/>
			</fileset>
		</delete>
		<copy file="LICENSE" todir="${out.dir}/classes/META-INF" overwrite="true" force="true"/>
		<jar destfile="${out.dir}/${prj.name}-${VERSION}.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.org}"/>
				<attribute name="Built-By" value="${prj.org}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/> 
				<attribute name="Implementation-Vendor" value="${prj.url}"/>
			</manifest>
			<fileset dir="${out.dir}/classes"/>
		</jar>
	</target>
	
</project>
