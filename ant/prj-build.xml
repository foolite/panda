<?xml version="1.0" encoding="UTF-8"?>
<project name="prj-build">
	<property name="src.dir" value="src"/>
	<property name="out.dir" value="out"/>
	<property name="javac.source" value="1.6"/>
	<property name="javac.target" value="1.6"/>

	<tstamp>
		<format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss"/>
	</tstamp>

	<target name="build" depends="clean, cp-res, n2a, javac" description="Build the project"/>
	<target name="dist" depends="build, javadoc, jar" description="Distribute project as a jar file"/>

	<!-- path -->
	<path id="main.cp">
		<pathelement path="out/classes"/>
		<path refid="dep.cp"/>
	</path>

	<path id="lib.cp">
		<fileset dir="lib/api" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/gae" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/jdbc" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/run" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
		<fileset dir="lib/test" erroronmissingdir="false">
			<include name="*.jar"/>
			<exclude name="*-sources.jar"/>
		</fileset>
	</path>

	<!-- build -->
	<target name="clean" description="Delete everything in the output directory">
		<delete dir="${out.dir}"/>
	</target>

	<target name="cp-res" description="Copy resource files to the classes directory">
		<mkdir dir="${out.dir}/classes"/>
		<delete>
			<fileset dir="${out.dir}/classes">
				<exclude name="**/*.class"/>
			</fileset>
		</delete>
		<copy todir="${out.dir}/classes" preservelastmodified="true">
			<fileset dir="${src.dir}/main/java">
				<exclude name="**/*.java"/>
			</fileset>
			<fileset dir="${src.dir}/main/resources" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${src.dir}/main/templates" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${src.dir}/gen/java" erroronmissingdir="false">
				<exclude name="**/*.java"/>
			</fileset>
			<fileset dir="${src.dir}/gen/resources" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
			<fileset dir="${src.dir}/gen/templates" erroronmissingdir="false">
				<include name="**/*"/>
			</fileset>
		</copy>
	</target>

	<target name="dir-chk">
		<available file="${dir}" type="dir" property="dir.exists"/>
	</target>
	<target name="n2a-do" depends="dir-chk" if="dir.exists">
		<native2ascii src="${dir}" dest="${out.dir}/classes" encoding="UTF-8" includes="**/*_*.properties"/>
	</target>
	<target name="n2a" description="Convert native properties to ascii properties">
		<delete>
			<fileset dir="${out.dir}/classes">
				<include name="**/*_*.properties"/>
			</fileset>
		</delete>
		<antcall target="n2a-do">
			<param name="dir" value="${src.dir}/main/resources"/>
		</antcall>
		<antcall target="n2a-do">
			<param name="dir" value="${src.dir}/gen/resources"/>
		</antcall>
	</target>

	<target name="javac" description="Compile java source files">
		<mkdir dir="${out.dir}/classes"/>
		<touch>
			<fileset dir="${src.dir}/main/java" includes="**/package-info.java"/>
			<fileset dir="${src.dir}/gen/java" includes="**/package-info.java" erroronmissingdir="false"/>
		</touch>
		<condition property="srcdir" value="${src.dir}/main/java:src/gen/java">
			<available file="${src.dir}/gen/java"/>
		</condition>
		<property name="srcdir" value="${src.dir}/main/java"/>
		<javac
			srcdir="${srcdir}" destdir="${out.dir}/classes" 
			encoding="UTF-8" source="${javac.source}" target="${javac.target}" 
			debug="true" includeAntRuntime="false">
			<classpath refid="main.cp"/>
		</javac>
	</target>

	<!-- dist -->
	<target name="javadoc" description="Generate java documents">
		<delete includeemptydirs="true">
			<fileset dir="${out.dir}">
				<include name="javadoc/**"/>
				<include name="*-javadoc.jar"/>
			</fileset>
		</delete>
		<javadoc 
			destdir="${out.dir}/javadoc"
			encoding="UTF-8" docencoding="UTF-8" charset="UTF-8" locale="en_US"
			use="true" splitindex="true"
			windowTitle="${prj.title} ${prj.version} API"
			doctitle="${prj.title} ${prj.version} API"
			footer="&lt;a href=&quot;${prj.url}&quot;&gt;${prj.url}&lt;/a&gt;"
		>
			<fileset dir="${src.dir}/main/java"/>
			<fileset dir="${src.dir}/gen/java" erroronmissingdir="false"/>
			<classpath refid="main.cp"/>
		</javadoc>
		<jar destfile="${out.dir}/${prj.name}-${VERSION}-javadoc.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.org}"/>
				<attribute name="Built-By" value="${prj.org}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/>
				<attribute name="Implementation-Vendor" value="${prj.url}"/>
			</manifest>
			<fileset dir="${out.dir}/javadoc"/>
		</jar>
	</target>

	<target name="jar" description="Make project as a jar file">
		<delete>
			<fileset dir="${out.dir}">
				<include name="*.jar"/>
				<exclude name="*-javadoc.jar"/>
			</fileset>
		</delete>
		<copy file="LICENSE" todir="${out.dir}/classes/META-INF" overwrite="true" force="true"/>
		<jar destfile="${out.dir}/${prj.name}-${VERSION}.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.org}"/>
				<attribute name="Built-By" value="${prj.org}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/> 
				<attribute name="Implementation-Vendor" value="${prj.url}"/>
			</manifest>
			<fileset dir="${out.dir}/classes"/>
		</jar>
		<jar destfile="${out.dir}/${prj.name}-${VERSION}-sources.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.org}"/>
				<attribute name="Built-By" value="${prj.org}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/> 
				<attribute name="Implementation-Vendor" value="${prj.url}"/>
			</manifest>
			<fileset dir="${src.dir}/main/java"/>
			<fileset dir="${src.dir}/main/resources" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/main/templates" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/gen/java" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/gen/resources" erroronmissingdir="false"/>
			<fileset dir="${src.dir}/gen/templates" erroronmissingdir="false"/>
			<fileset dir="${out.dir}/classes" includes="META-INF/LICENSE"/>
		</jar>
	</target>

</project>
