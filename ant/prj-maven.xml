<?xml version="1.0" encoding="UTF-8"?>
<project name="prj-maven" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
	<property name="out.dir" value="out"/>

	<!-- usage -->
	<property name="usage-mvn" value="
&#10;mvn-pom          --&gt; Generate pom.xml
&#10;mvn-local-deploy --&gt; Deploy release version to local maven repository
&#10;mvn-oss-deploy   --&gt; Deploy snapshot version to maven snapshot repository
&#10;mvn-oss-stage    --&gt; Deploy release version to maven staging repository
"/>

	<!-- set project property -->
	<property name="prj.type" value="jar"/>
	<property name="prj.license" value="Apache 2.0"/>
	<property name="prj.license.url" value="http://www.apache.org/licenses/LICENSE-2.0"/>

	<!-- defined maven snapshots and staging repository id and url -->
	<property name="mvn.ssr.id" value="sonatype-nexus-snapshots" />
	<property name="mvn.ssr.url" value="https://oss.sonatype.org/content/repositories/snapshots" />
	<property name="mvn.sgr.id" value="sonatype-nexus-staging" />
	<property name="mvn.sgr.url" value="https://oss.sonatype.org/service/local/staging/deploy/maven2/" />

	<!-- maven -->
	<macrodef name="writepom">
		<attribute name="version" default="${prj.version}"/>
		<sequential>
			<echo>version = @{version}</echo>
			<copy file="pom.xml" todir="${out.dir}" overwrite="true" force="true"/>
			<replaceregexp file="${out.dir}/pom.xml"
				match="&lt;version&gt;.*&lt;/version&gt;"
				replace="&lt;version&gt;@{version}&lt;/version&gt;"
				byline="true"
				encoding="ISO-8859-1"/>
		</sequential>
	</macrodef>

	<target name="mvn-pom" description="Write maven pom.xml">
		<writepom/>
	</target>
	
	<!-- local maven deploy -->
	<target name="mvn-local-deploy" description="Deploy release version to local maven repository">
		<!-- copy pom.xml -->
		<copy file="pom.xml" todir="${out.dir}" overwrite="true" force="true"/>

		<property name="location.repo" location="${prj.repo}"/>

		<condition property="argsrc" value="-Dsources=${prj.name}-${VERSION}-sources.jar">
			<available file="${out.dir}/${prj.name}-${VERSION}-sources.jar"/>
		</condition>
		<property name="argsrc" value="-Dsources.dummy=true"/>

		<condition property="argdoc" value="-Djavadoc=${prj.name}-${VERSION}-javadoc.jar">
			<available file="${out.dir}/${prj.name}-${VERSION}-javadoc.jar"/>
		</condition>
		<property name="argdoc" value="-Djavadoc.dummy=true"/>

		<!-- deploy the artifact -->
		<artifact:mvn pom="${out.dir}/pom.xml">
			<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy-file" />
			<arg value="-Durl=file://${location.repo}" />
			<arg value="-DcreateChecksum=true" />
			<arg value="-DupdateReleaseInfo=true" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-Dfile=${prj.name}-${VERSION}.${prj.type}" />
			<arg value="${argsrc}" />
			<arg value="${argdoc}" />
		</artifact:mvn>
	</target>
	
	<!-- mvn sonatype snapshot deploy -->
	<target name="mvn-oss-snapshot" description="Deploy snapshot version to maven snapshot repository">
		<!-- write pom.xml -->
		<writepom version="${prj.version}-SNAPSHORT"/>

		<!-- deploy the artifact -->
		<artifact:mvn pom="${out.dir}/pom.xml">
			<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.8.1:deploy-file" />
			<arg value="-Durl=${mvn.ssr.url}" />
			<arg value="-DrepositoryId=${mvn.ssr.id}" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-Dfile=${prj.name}-${VERSION}.${prj.type}" />
		</artifact:mvn>
	</target>

	<!-- mvn sonatype release deploy -->
	<target name="mvn-oss-stage" description="Deploy release version to maven staging repository">
		<!-- copy pom.xml -->
		<copy file="pom.xml" todir="${out.dir}" overwrite="true" force="true"/>

		<condition property="argsrc" value="-Dsources=${prj.name}-${VERSION}-sources.jar">
			<available file="${out.dir}/${prj.name}-${VERSION}-sources.jar"/>
		</condition>
		<property name="argsrc" value="-Dsources.dummy=true"/>

		<condition property="argdoc" value="-Djavadoc=${prj.name}-${VERSION}-javadoc.jar">
			<available file="${out.dir}/${prj.name}-${VERSION}-javadoc.jar"/>
		</condition>
		<property name="argdoc" value="-Djavadoc.dummy=true"/>

		<!-- sign and deploy the artifact -->
		<artifact:mvn pom="${out.dir}/pom.xml">
			<arg value="org.apache.maven.plugins:maven-gpg-plugin:1.4:sign-and-deploy-file" />
			<arg value="-Pgpg" />
			<arg value="-Durl=${mvn.sgr.url}" />
			<arg value="-DrepositoryId=${mvn.sgr.id}" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-DupdateReleaseInfo=true" />
			<arg value="-Dfile=${prj.name}-${VERSION}.${prj.type}" />
			<arg value="${argsrc}" />
			<arg value="${argdoc}" />
		</artifact:mvn>
	</target>
</project>
