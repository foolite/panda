<?xml version="1.0" encoding="UTF-8"?>
<project name="panda-web" default="usage" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
	<!-- set global properties for this build -->
	<property name="prj.org" value="pandawind"/>
	<property name="prj.name" value="panda-web"/>
	<property name="prj.title" value="Panda Web Framework"/>
	<property name="prj.author" value="yf.frank.wang@gmail.com"/>
	<property name="prj.site" value="github.com/pandawind/panda-web"/>
	<loadfile srcFile="${basedir}/../panda-java/src/main/java/panda/Panda.java" property="prj.version" encoding="UTF-8" failonerror="false">
		<filterchain>
			<striplinebreaks/>
			<linecontains>
				<contains value="VERSION"/>
			</linecontains>
			<tokenfilter>
				<replaceregex pattern="(.*)&quot;(.*)&quot;.*" replace="\2"/>
			</tokenfilter>
		</filterchain>
	</loadfile>
	<property name="prj.version" value="0.1.0"/>

	<exec dir="${basedir}" executable="git" outputproperty="git.info" failifexecutionfails="false">
		<arg line="rev-list --all --count"/>
	</exec>
	<script language="javascript">
		var gi = project.getProperty("git.info");
		var rev = gi == null ? "0" : gi.trim();
		project.setProperty("REVISION", rev);
		project.setProperty("VERSION", project.getProperty("prj.version") + "." + rev);
	</script>

	<target name="usage">
		<echo message=""/>
		<echo message="${prj.name}-${VERSION} build file"/>
		<echo message="-----------------------------------"/>
		<echo message=""/>
		<echo message="Available targets are:"/>
		<echo message=""/>
		<echo message="all          --> dist &amp; test"/>
		<echo message="build        --> Build the project (minjs, mincss)"/>
		<echo message="min-css      --> Merge &amp; minify css files"/>
		<echo message="min-js       --> Merge &amp; minify javascript files"/>
		<echo message="dist         --> Distribute project as a jar file (build, jar)"/>
		<echo message="jar          --> Make the project as a jar file"/>
		<echo message=""/>
	</target>

	<!-- ivy -->
	<target name="ivy-resolve" description="ivy --> retreive dependencies">
		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="lib/tool"/>
		</delete>
		<ivy:retrieve conf="tool" pattern="lib/tool/[artifact](-[classifier]).[ext]"/>
	</target>

	<target name="ivy-cleancache" description="ivy --> clean the cache">
		<ivy:cleancache />
	</target>

	<!-- build -->
	<target name="min-js" description="Merge &amp; minify javascript files">
		<concat destfile="src/main/bootstrap2/js/bootstrap-datetimepicker-i18n.js" binary="true">
			<fileset dir="src/main/bootstrap2/js/locales">
				<include name="*.js"/>
			</fileset>
		</concat>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/bootstrap2/js/bootstrap-datetimepicker-i18n.js"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="js"/>
			<arg value="-o"/>
			<arg value="src/main/bootstrap2/js/bootstrap-datetimepicker-i18n.min.js"/>
		</java>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/bootstrap2/js/bootstrap-datetimepicker.js"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="js"/>
			<arg value="-o"/>
			<arg value="src/main/bootstrap2/js/bootstrap-datetimepicker.min.js"/>
		</java>

		<concat destfile="src/main/bootstrap3/js/bootstrap-datetimepicker-i18n.js" binary="true">
			<fileset dir="src/main/bootstrap3/js/locales">
				<include name="*.js"/>
			</fileset>
		</concat>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/bootstrap3/js/bootstrap-datetimepicker-i18n.js"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="js"/>
			<arg value="-o"/>
			<arg value="src/main/bootstrap3/js/bootstrap-datetimepicker-i18n.min.js"/>
		</java>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/bootstrap3/js/bootstrap-datetimepicker.js"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="js"/>
			<arg value="-o"/>
			<arg value="src/main/bootstrap3/js/bootstrap-datetimepicker.min.js"/>
		</java>

		<concat destfile="src/main/panda/js/panda.js" binary="true">
			<fileset dir="src/main/panda/js">
				<include name="core.*.js"/>
				<include name="ui.*.js"/>
			</fileset>
		</concat>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/panda/js/panda.js"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="js"/>
			<arg value="-o"/>
			<arg value="src/main/panda/js/panda.min.js"/>
		</java>

		<concat destfile="src/main/jquery/js/jquery-plugins.js" binary="true">
			<fileset dir="src/main/jquery/js" includes="jquery.*.js"/>
		</concat>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/jquery/js/jquery-plugins.js"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="js"/>
			<arg value="-o"/>
			<arg value="src/main/jquery/js/jquery-plugins.min.js"/>
		</java>
<!-- 
		<concat destfile="src/main/jquery/js/jquery-plugins-ja.js" binary="true">
			<fileset dir="src/main/jquery/js/i18n" includes="*-ja.js"/>
		</concat>
		<jsmin charset="UTF-8" 
			jsfile="src/main/jquery/js/jquery-plugins-ja.js" 
			minfile="src/main/jquery/js/jquery-plugins-ja.min.js"/>

		<concat destfile="src/main/jquery/js/jquery-plugins-zh-CN.js" binary="true">
			<fileset dir="src/main/jquery/js/i18n" includes="*-zh-CN.js"/>
		</concat>
		<jsmin charset="UTF-8" 
			jsfile="src/main/jquery/js/jquery-plugins-zh-CN.js" 
			minfile="src/main/jquery/js/jquery-plugins-zh-CN.min.js"/>

		<concat destfile="src/main/jquery/js/jquery-plugins-zh-TW.js" binary="true">
			<fileset dir="src/main/jquery/js/i18n" includes="*-zh-TW.js"/>
		</concat>
		<jsmin charset="UTF-8" 
			jsfile="src/main/jquery/js/jquery-plugins-zh-TW.js" 
			minfile="src/main/jquery/js/jquery-plugins-zh-TW.min.js"/>

		<concat destfile="src/main/jquery/js/jquery-plugins-zh-HK.js" binary="true">
			<fileset dir="src/main/jquery/js/i18n" includes="*-zh-HK.js"/>
		</concat>
		<jsmin charset="UTF-8" 
			jsfile="src/main/jquery/js/jquery-plugins-zh-HK.js" 
			minfile="src/main/jquery/js/jquery-plugins-zh-HK.min.js"/>
-->
	</target>

	<target name="min-css" description="Merge &amp; minify css files">
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/bootstrap2/css/bootstrap-datetimepicker.css"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="css"/>
			<arg value="-o"/>
			<arg value="src/main/bootstrap2/css/bootstrap-datetimepicker.min.css"/>
		</java>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/bootstrap3/css/bootstrap-datetimepicker.css"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="css"/>
			<arg value="-o"/>
			<arg value="src/main/bootstrap3/css/bootstrap-datetimepicker.min.css"/>
		</java>

		<concat destfile="src/main/panda/css/panda.css" binary="true">
			<fileset dir="src/main/panda/css" includes="ui.*.css"/>
		</concat>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/panda/css/panda.css"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="css"/>
			<arg value="-o"/>
			<arg value="src/main/panda/css/panda.min.css"/>
		</java>

		<concat destfile="src/main/jquery/css/jquery-plugins.css" binary="true">
			<fileset dir="src/main/jquery/css" includes="jquery.*.css"/>
		</concat>
		<java jar="lib/tool/yuicompressor.jar" fork="true">
			<arg value="src/main/jquery/css/jquery-plugins.css"/>
			<arg value="--charset"/>
			<arg value="UTF-8"/>
			<arg value="--type"/>
			<arg value="css"/>
			<arg value="-o"/>
			<arg value="src/main/jquery/css/jquery-plugins.min.css"/>
		</java>
	</target>

	<target name="build" depends="ivy-resolve, min-js, min-css" description="Build the project"/>

	<target name="jar" description="Make project as a jar file">
		<delete dir="out"/>
		<jar destfile="out/${prj.name}-${VERSION}.jar">
			<manifest>
				<attribute name="Created-By" value="${prj.author}"/>
				<attribute name="Built-By" value="${prj.author}"/>
				<attribute name="Built-Date" value="${TODAY}"/>
				<attribute name="Implementation-Title" value="${prj.title}"/>
				<attribute name="Implementation-Version" value="${VERSION}"/> 
				<attribute name="Implementation-Vendor" value="${prj.site}"/>
			</manifest>
			<fileset dir="src/main">
				<include name="**"/>
			</fileset>
		</jar>
	</target>
	
	<target name="ghp" description="Copy panda sources to panda-web gh-pages branch">
		<delete dir="../panda-web-ghp/${prj.version}"/>
		<mkdir dir="../panda-web-ghp/${prj.version}"/>
		<copy todir="../panda-web-ghp/${prj.version}" preservelastmodified="true">
			<fileset dir="src/main">
				<include name="panda/**"/>
				<include name="bootstrap3/**"/>
			</fileset>
		</copy>
	</target>

	<target name="dist" depends="build, jar" description="Distribute project as a jar file"/>

	<target name="all" depends="dist"/>
</project>
